<!DOCTYPE html>

<html lang="en">

<head>
    <title>World Population 1961-2018</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="d3.js"></script>
    <script src="d3leg.js"></script>
    <meta charset="utf-8">
</head>

<body>
    <h1>Visualisation Coursework - World Population</h1>
    <svg width="100%" height="700" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>



    <script>
            // Based loosely from this D3 bubble graph https://bl.ocks.org/mbostock/4063269
            // And this Forced directed diagram https://bl.ocks.org/mbostock/4062045
            

        </script>

        <script>
            class Visualisation{
                constructor(pathtocsv){
                    this.svg = d3.select("svg");
                    this.width = document.body.clientWidth;
                    this.height = +this.svg.attr('height');
                    this.centerX = this.width * 0.5;
                    this.centerY = this.height * 0.5;
                    this.strength = 0.20;
                    this.focusedNode;

                    this.format = d3.format(",d");

                    this.scaleColor = d3.scaleOrdinal(d3.schemeCategory20);
                
                    this.excludes = ["ARB","CEB","CSS","EAP","EAR","EAS","ECA","ECS","EMU","EUU","FCS","HIC","HPC","IBD","IBT","IDA","IDB","IDX","INX","LAC","LCN","LDC","LIC","LMC","LMY","LTE","MEA","MIC","MNA","NAC","OED","OSS","PRE","PSS","PST","SSA","SSF","SST","TEA","TEC","TLA","TMN","TSA","TSS","UMC","WLD","SAS"]
                    // This list contains all of the iso-3 country codes appearing in world bank datasets that aren't actually countries (but are instead groups of countries)


                    let self = this; // This is a weird hack to let us call the d3 function from inside the class
                    d3.csv(pathtocsv,this.processRow,function(data){
                        self.startVis(data);
                    });

                    //this.startVis();
                }

                startVis(dat){
                    console.log(dat);
                    this.pack = d3.pack().size([this.width,this.height]).padding(1.5);
                    this.forceCollide = d3.forceCollide(d => d.r + 1);
                    this.simulation = d3.forceSimulation().force('charge', d3.forceManyBody()).force('collide', this.forceCollide).force('x', d3.forceX(this.centerX ).strength(this.strength)).force('y', d3.forceY(this.centerY ).strength(this.strength));
                    // reduce number of circles on mobile screen due to slow computation
		            if ('matchMedia' in window && window.matchMedia('(max-device-width: 767px)').matches) {
			            dat = dat.filter(el => {
				        return el.value >= 500000;
                        });
                    }

                    dat = dat.filter(el => {
                        return !(this.excludes.includes(el.code));
                    })

                    this.root = d3.hierarchy({ children: dat }).sum(function(d){
                        if (d.dseries == undefined){
                            return 0;
                        }
                        else{
                            return d.dseries[0][1];
                        }
                    });

                    this.nodes = this.pack(this.root).leaves().map(node => {
                        const data = node.data;
                        //console.log(data);
                        //console.log(data.dseries[0][1]);
                        //console.log(node.r);
                        return{
                            x: this.centerX + (node.x - this.centerX) * 3, // magnify start position to have transition to center movement
				            y: this.centerY + (node.y - this.centerY) * 3,
				            r: 0, // for tweening
				            radius: Math.sqrt(data.dseries[0][1])*0.0050, //original radius
				            id: data.code,
				            name: data.name,
				            value: data.dseries[0][1],
				            //icon: data.icon,
				            //desc: data.desc,
                        }
                    });

                    let self = this;

                    this.svg.style("background-color","#eee");
                    this.node = this.svg.selectAll('.node')
                        .data(this.nodes)
			            .enter().append('g')
			            .attr('class', 'node')
			            .call(d3.drag()
				            .on('start', (d) => {
					        if (!d3.event.active) self.simulation.alphaTarget(0.2).restart();
					        d.fx = d.x;
					        d.fy = d.y;
				        })
				        .on('drag', (d) => {
					        d.fx = d3.event.x;
					        d.fy = d3.event.y;
				        })
				        .on('end', (d) => {
					        if (!d3.event.active) self.simulation.alphaTarget(0);
					        d.fx = null;
					        d.fy = null;
				        }));
                    
                    this.node.append("circle")
                        .attr('id', d => d.id)
			            .attr('r', 0)
			            .style('fill', d => this.scaleColor(d.cat))
			            .transition().duration(2000).ease(d3.easeElasticOut)
				            .tween('circleIn', function(d){
					        let i = d3.interpolateNumber(0, d.radius);
					        return (t) => {
						        d.r = i(t);
						        self.simulation.force('collide', self.forceCollide);
                            }
                            });

                    //this.node.append("clipPath")
                    //    .attr("id", d => `clip-"${d.id}`)
                    //    .attr("use")
                    //    .attr("xlink:href", d => `#${d.id}`);
                    
                    //this.node.append("title")
                    //    .text(d => (d.cat + "::" + d.name + "\n" + format(d.value)));

                    this.simulation.nodes(this.nodes).on("tick",function(){
                        this.node = d3.select("svg").selectAll('.node').attr("transform", d => `translate(${d.x},${d.y})`).select("circle").attr("r", d => d.r);
                    });

                    /*let infoBox = this.node.append('foreignObject')
			            .classed('circle-overlay', true)
			            .attr('x', -350 * 0.5 * 0.8)
			            .attr('y', -0 * 0.5 * 0.8)
			            .attr('height', 350 * 0.8)
			            .attr('width', 350 * 0.8)
				        .append('xhtml:div')
				        .classed('circle-overlay__inner', true);

		            infoBox.append('h2')
			            .classed('circle-overlay__title', true)
			            .text(d => d.name);*/
                }

                test(){
                    console.log(this.node);
                }

                ticked(){
                    this.node
                        .attr("transform", d => `translate(${d.x},${d.y})`)
                        .select("circle")
                            .attr("r", d => d.r);
                }

                processRow(d){ // Function to process each row
                    let dataseries = []; // Array to store dataseries
                    for (let i = 1961; i < 2019; i++){ // Iterate over every year in the dataset
                        let result = parseInt(d[i]);
                        if (!result){
                            result = 0;
                        }
                        dataseries.push([i.toString(),result]); // Add a two-element array containing the year and the stat
                    }
                    return{
                        name: d["Country Name"], // Returns the country name,
                        code: d["Country Code"], // The country code
                        dseries: dataseries // And the data set
                }
            }
            }

            
            function processCSV(path){ // Function to load in a csv
                d3.csv(path,processRow,getData); // Uses d3.csv to access the file
            }

            function processRow(d){ // Function to process each row
                    let dataseries = [] // Array to store dataseries
                    for (let i = 1961; i < 2019; i++){ // Iterate over every year in the dataset
                        dataseries.push([i.toString(),parseInt(d[i])]); // Add a two-element array containing the year and the stat
                    }
                    return{
                        name: d["Country Name"], // Returns the country name,
                        code: d["Country Code"], // The country code
                        dseries: dataseries // And the data set
                    };
            }

            function getData(data){
                console.log(data); // Logs the result
            }

            //processCSV("https://raw.githubusercontent.com/muppet2011ad/visualisation-coursework/master/popdat.csv?token=AEU4F7F537S657Q2H5JHHL257DHWK");

            let vis = new Visualisation("https://raw.githubusercontent.com/muppet2011ad/visualisation-coursework/master/popdat.csv?token=AEU4F7AADO6NCNMXCKZXQAC6AY3SU");

        </script>
</body>

</html>